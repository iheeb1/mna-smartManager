<app-header></app-header>

<!-- Mobile Hero Section -->
<div class="mobile-hero-section">
  <div class="mobile-hero-content">
    <div class="mobile-hero-header">
      <h1 class="hero-title">شيقات لم تنفرع</h1>
      <a href="javascript:void(0)" class="back-link" (click)="goBack()">
        <span>العودة للتقارير</span>
        <i class="pi pi-angle-left"></i>
      </a>
    </div>
  </div>

  <div class="mobile-action-bar">
    <button class="action-btn">
      <img src="assets/icons/calendar_icon.svg" alt="Calendar">
    </button>
    <button class="action-btn filter-mobile-btn">
      <img src="assets/icons/filters_icon.svg" alt="Filter">
    </button>
    <div class="mobile-search-input">
      <div class="search-icon">
        <img src="assets/icons/search_icon.svg" alt="search">
      </div>
      <input type="text" placeholder="بحث عن شيك" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()">
    </div>
  </div>
</div>

<p-toast position="top-center"></p-toast>

<div class="container">
  <div class="header">
    <div class="header-actions">
      <button pButton class="export-btn" (click)="exportData()">
        <img src="assets/icons/export_icon.svg" alt="export">
        <span>تصدير</span>
      </button>
      <button pButton class="p-button-text print-btn" (click)="printTable()">
        <img src="assets/icons/print_icon.svg" alt="print">
      </button>
      <button pButton label="إضافة شيك جديد" (click)="addNewCheck()" class="p-button-primary add-btn"></button>
    </div>
    <div class="header-title">
      <h1>الشيكات المحصلة</h1>
      <a href="javascript:void(0)" class="back-link" (click)="goBack()">
        <span>العودة للتقارير</span>
        <i class="pi pi-angle-left"></i>
      </a>
    </div>
  </div>

  <div class="content-card">

    <!-- Loading spinner -->
    <div *ngIf="isLoading" class="loading-container">
      <p-progressSpinner styleClass="custom-spinner" strokeWidth="4" animationDuration="1s">
      </p-progressSpinner>
      <p>جاري تحميل الشيكات...</p>
    </div>

    <!-- Empty state -->
    <div *ngIf="!isLoading && filteredChecks.length === 0 && !searchQuery" class="empty-state">
      <h2>لا توجد شيكات محصلة حتى الآن</h2>
      <p>ابدأ بإضافة شيك جديد لإدارة المعاملات المالية</p>
    </div>

    <!-- Table with data -->
    <div *ngIf="!isLoading && (filteredChecks.length > 0 || searchQuery)">
      <div class="search-bar">
        <button class="filter-text-btn" (click)="clearSearch()">مسح الكل</button>
        <button pButton class="filter-btn">
          <img src="assets/icons/filters_icon.svg" alt="filter">
        </button>
        <span class="p-input-icon-left search-input">
          <div class="search-icon">
            <img src="assets/icons/search_icon.svg" alt="search">
          </div>
          <input type="text" pInputText placeholder="بحث عن شيك..." [(ngModel)]="searchQuery"
            (ngModelChange)="onSearch()">
        </span>
      </div>

      <!-- No search results -->
      <div *ngIf="filteredChecks.length === 0 && searchQuery" class="empty-state">
        <h2>لا توجد نتائج</h2>
        <p>لم يتم العثور على شيكات تطابق بحثك</p>
      </div>

      <!-- Desktop Table content -->
      <div *ngIf="filteredChecks.length > 0" class="desktop-table">
        <div class="table-header">
          <div class="header-cell action"></div>
          <div class="header-cell amount">المبلغ</div>
          <div class="header-cell notes">ملاحظات</div>
          <div class="header-cell payment-date">تاريخ الدفع</div>
          <div class="header-cell check-num">رقم الشيك</div>
          <div class="header-cell account">رقم الحساب</div>
          <div class="header-cell bank">البنك</div>
          <div class="header-cell customer">اسم العميل</div>
          <div class="header-cell date">التاريخ</div>
        </div>

        <div class="table-body">
          <div class="table-row" *ngFor="let check of filteredChecks">
            <div class="row-cell action">
              <!-- Desktop buttons -->
              <button pButton icon="pi pi-trash" class="p-button-text p-button-rounded p-button-sm delete-btn"
                (click)="deleteCheck(check)">
              </button>
              <button pButton icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-sm edit-btn"
                (click)="editCheck(check)">
              </button>

              <!-- Mobile menu button -->
              <button pButton icon="pi pi-ellipsis-v" class="p-button-text p-button-rounded p-button-sm menu-btn"
                (click)="showCheckMenu($event, check)">
              </button>
            </div>
            <div class="row-cell amount">{{ check.amount }}₪</div>
            <div class="row-cell notes">{{ check.notes || '-' }}</div>
            <div class="row-cell payment-date">{{ check.paymentDate }}</div>
            <div class="row-cell check-num">{{ check.checkNumber }}</div>
            <div class="row-cell account">{{ check.accountNumber }}</div>
            <div class="row-cell bank">{{ check.bank }}</div>
            <div class="row-cell customer">
              <a href="#" class="plate-link" (click)="viewCheckDetails(check, $event)">{{ check.customerName }}</a>
            </div>
            <div class="row-cell date">{{ check.date }}</div>
          </div>
        </div>

        <!-- Table Footer with Total -->
        <div class="table-footer">
          <div class="footer-cell action"></div>
          <div class="footer-cell amount"><span class="total-badge">{{ getTotalAmount() }}₪</span></div><div class="footer-cell notes"><span class="total-badge">:المجموع الكلي</span></div>
          <div class="footer-cell payment-date"></div>
          <div class="footer-cell check-num"></div>
          <div class="footer-cell account"></div>
          <div class="footer-cell bank"></div>
          <div class="footer-cell customer"></div>
          <div class="footer-cell date"></div>
        </div>
      </div>

      <!-- Mobile Cards View -->
      <div *ngIf="filteredChecks.length > 0" class="mobile-cards">
        <div class="check-card" *ngFor="let check of filteredChecks" [class.expanded]="check.id === expandedCheckId">
          <div class="card-header" (click)="toggleCard(check.id)">
            <div class="card-header-content">
                <div class="card-title">
                    <button class="menu-btn" (click)="showCheckMenu($event, check); $event.stopPropagation()">
                        <i class="pi pi-ellipsis-v"></i>
                    </button>
                    <span class="date-label">{{ check.date }}</span>
                    <span class="status-label">משתאבת מאור</span>
                  </div>
              <div class="card-info-row">
                <div class="info-item">
                  <span class="info-label">יתרה</span>
                  <span class="info-value amount-highlight">{{ check.amount }}₪</span>
                </div>
                <div class="info-item">
                  <span class="info-label">תאריך פרעון</span>
                  <span class="info-value">{{ check.paymentDate }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">מספר שיק</span>
                  <span class="info-value">{{ check.checkNumber }}</span>
                </div>
              </div>
              
            </div>
            <div class="expand-icon">
              <i class="pi" [class.pi-chevron-down]="check.id !== expandedCheckId" 
                 [class.pi-chevron-up]="check.id === expandedCheckId"></i>
            </div>
          </div>

          <div class="card-details" *ngIf="check.id === expandedCheckId">
            <div class="detail-row">
              <div class="detail-item">
                <span class="detail-label">בנק</span>
                <span class="detail-value">{{ check.bank }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">מספר חשבון</span>
                <span class="detail-value">{{ check.accountNumber }}</span>
              </div>
            </div>
            <div class="detail-full">
              <span class="detail-label">הערות</span>
              <p class="detail-text">{{ check.notes || 'לורם איפסום דולור סיט אמט, קונסקטור אדיפיסינג' }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Single menu component placed outside the loop -->
<p-menu #checkMenu [model]="checkMenuItems" [popup]="true" appendTo="body" styleClass="car-menu"></p-menu>

<app-footer-nav></app-footer-nav>