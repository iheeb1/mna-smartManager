<p-dialog 
  [(visible)]="visible" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="onDialogHide()"
  [baseZIndex]="10"
  [styleClass]="isMobile ? 'mobile-add-order-dialog' : 'add-order-dialog'"
  [position]="isMobile ? 'bottom' : 'center'"
  [style]="{width: isMobile ? '100%' : '85vw', height: isMobile ? '100vh' : '90vh'}">
  
  <!-- DESKTOP VIEW - EXACTLY AS BEFORE -->
  <div class="dialog-wrapper" *ngIf="!isMobile">
    <!-- Left Side - Form -->
    <div class="form-side">
      
      <!-- Customer Details Section -->
      <div class="section-block">
        <div class="header-row">
          <h3 class="section-title">تفاصيل العميل</h3>
        </div>

        <div class="input-row">
          <div class="input-col">
            <span class="input-label">اسم العميل/المستفيد</span>
            <p-dropdown 
              [(ngModel)]="orderData.customerId"
              [options]="customerOptions" 
              placeholder="اختر عميل"
              [showClear]="true"
              [filter]="true"
              (onChange)="onCustomerChange($event)">
            </p-dropdown>
          </div>
          
          <div class="input-col">
            <span class="input-label">رقم المركبة</span>
            <p-dropdown 
              [(ngModel)]="orderData.carId"
              [options]="vehicleOptions" 
              placeholder="اختر رقم"
              [showClear]="true"
              [filter]="true"
              [disabled]="!orderData.customerId">
            </p-dropdown>
          </div>
        </div>
      </div>

      <div class="line-divider"></div>

      <!-- Order Details Section -->
      <div class="section-block">
        <div class="header-row">
          <h3 class="section-title">تفاصيل الطلب</h3>
        </div>

        <div class="input-row">
          <div class="input-col">
            <span class="input-label">العنوان</span>
            <p-dropdown 
              [(ngModel)]="orderData.addressLine1"
              [options]="addressOptions" 
              placeholder="اختر عنوان"
              [showClear]="true"
              [filter]="true"
              [disabled]="!orderData.customerId">
            </p-dropdown>
          </div>
          
          <div class="input-col">
            <span class="input-label">تاريخ الطلب</span>
            <p-calendar 
              [(ngModel)]="orderData.orderDate" 
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              placeholder="—/—/—">
            </p-calendar>
          </div>
        </div>

        <div class="input-row">
          <div class="input-col">
            <div class="checkbox-wrapper-inline">
              <p-checkbox 
                [(ngModel)]="orderData.includeVAT" 
                [binary]="true"
                (onChange)="onVATChange()">
              </p-checkbox>
              <label class="check-text">يشمل الضريبة</label>
            </div>
          </div>
          
          <div class="input-col">
            <span class="input-label">ما هو رقم العقد؟</span>
            <input 
              pInputText 
              type="text" 
              [(ngModel)]="orderData.contractNumber"
              placeholder="أدخل رقم العقد" />
          </div>
        </div>
      </div>

      <div class="line-divider"></div>

      <!-- Items Section -->
      <div class="section-block">
        <div class="header-row">
          <h3 class="section-title">تفاصيل المنتجات</h3>
        </div>

        <div *ngFor="let row of orderItemRows; let i = index" class="item-row-container">
          <div class="input-row">
            <div class="input-col">
              <span class="input-label">المنتج/كود المنتج</span>
              <p-dropdown 
                [(ngModel)]="row.productId"
                [options]="productOptions" 
                placeholder="اختر منتج"
                [showClear]="true"
                [filter]="true"
                (onChange)="onProductChange(i, $event)">
              </p-dropdown>
            </div>
            
            <div class="input-col">
              <span class="input-label">الكمية</span>
              <input 
                pInputText 
                type="number" 
                [(ngModel)]="row.quantity"
                (ngModelChange)="onQuantityChange(i)"
                placeholder="0" 
                min="0" />
            </div>
            
            <div class="input-col">
              <span class="input-label">السعر</span>
              <input 
                pInputText 
                type="number" 
                [(ngModel)]="row.price"
                (ngModelChange)="onPriceChange(i)"
                placeholder="0.00" 
                min="0" 
                step="0.01" />
            </div>

            <div class="input-col delete-col" *ngIf="orderItemRows.length > 1">
              <button 
                pButton 
                type="button" 
                icon="pi pi-trash" 
                class="p-button-danger p-button-text p-button-sm delete-row-btn"
                (click)="removeRow(i)"
                pTooltip="حذف السطر">
              </button>
            </div>
          </div>

          <div class="input-row">
            <div class="input-col">
              <span class="input-label">الإجمالي</span>
              <input 
                pInputText 
                type="text" 
                [value]="formatCurrency(row.totalBeforeTax)"
                placeholder="0.00₪" 
                readonly />
            </div>
            
            <div class="input-col">
              <span class="input-label">الضريبة</span>
              <input 
                pInputText 
                type="text" 
                [value]="formatCurrency(row.taxAmount)"
                placeholder="0.00₪" 
                readonly />
            </div>
            
            <div class="input-col">
              <span class="input-label">الإجمالي مع الضريبة</span>
              <input 
                pInputText 
                type="text" 
                [value]="formatCurrency(row.totalWithTax)"
                placeholder="0.00₪" 
                readonly />
            </div>
          </div>
        </div>

        <div class="totals-row">
          <div class="total-item">
            <span>الإجمالي:</span>
            <span class="total-value">{{formatCurrency(getTotalBeforeTax())}}</span>
          </div>
          <div class="total-item">
            <span>الضريبة:</span>
            <span class="total-value">{{formatCurrency(getTotalTax())}}</span>
          </div>
          <div class="total-item">
            <span>الإجمالي مع الضريبة:</span>
            <span class="total-value">{{formatCurrency(getTotalWithTax())}}</span>
          </div>
        </div>

        <div class="add-line-btn-wrapper">
          <button 
            pButton 
            type="button" 
            label="+ إضافة سطر" 
            class="add-line-btn" 
            (click)="addRow()">
          </button>
        </div>
      </div>

      <div class="line-divider"></div>

      <!-- Notes Section -->
      <div class="section-block">
        <div class="header-row">
          <h3 class="section-title">ملاحظات وملخص</h3>
        </div>

        <div class="input-row">
          <div class="input-col full">
            <span class="input-label">ملاحظات</span>
            <input 
              pInputText 
              type="text" 
              [(ngModel)]="orderData.notes"
              placeholder="أدخل ملاحظات" />
          </div>
        </div>
      </div>

      <button 
        pButton 
        label="حفظ" 
        class="final-save-btn" 
        (click)="onSave()"
        [disabled]="loading">
      </button>
    </div>

    <!-- Right Side - Illustration -->
    <div class="illustration-side">
      <div class="image-overlay">
        <img src="assets/images/add_orders.png" alt="Add Order Illustration" />
        <h2>إضافة طلب جديد</h2>
      </div>
    </div>
  </div>

  <!-- MOBILE VIEW - ARABIC TRANSLATION -->
  <div class="mobile-form-container" *ngIf="isMobile">
    <!-- Mobile Header with Image -->
    <div class="mobile-form-image">
      <img src="assets/images/add_orders.png" alt="إضافة طلب">
      <button class="mobile-back-btn" (click)="closeDialog()">
        <i class="pi pi-arrow-right"></i>
      </button>
      <h2>إضافة طلب جديد</h2>
    </div>

    <!-- Mobile Form Content -->
    <div class="mobile-form-content">
      <!-- Customer Details -->
      <div class="mobile-section-title">تفاصيل العميل</div>
      
      <div class="mobile-field-group">
        <label>اسم العميل/المستفيد</label>
        <p-dropdown 
          [(ngModel)]="orderData.customerId"
          [options]="customerOptions" 
          placeholder="اختر عميل"
          [showClear]="true"
          [filter]="true"
          (onChange)="onCustomerChange($event)">
        </p-dropdown>
      </div>

      <div class="mobile-field-group">
        <label>رقم المركبة</label>
        <p-dropdown 
          [(ngModel)]="orderData.carId"
          [options]="vehicleOptions" 
          placeholder="اختر رقم"
          [showClear]="true"
          [filter]="true"
          [disabled]="!orderData.customerId">
        </p-dropdown>
      </div>

      <div style="height: 1px; border-top: 1px solid #B8B3FD; margin: 6px 0; width: 100%;"></div>
      <!-- Order Details -->
      <div class="mobile-section-title">تفاصيل الطلب</div>

      <div class="mobile-field-group">
        <label>تاريخ الطلب</label>
        <p-calendar 
          [(ngModel)]="orderData.orderDate" 
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          placeholder="—/—/—">
        </p-calendar>
      </div>

      <div class="mobile-field-group">
        <label>العنوان</label>
        <p-dropdown 
          [(ngModel)]="orderData.addressLine1"
          [options]="addressOptions" 
          placeholder="اختر عنوان"
          [showClear]="true"
          [filter]="true"
          [disabled]="!orderData.customerId">
        </p-dropdown>
      </div>

      <div class="mobile-field-group">
        <label>ما هو رقم العقد؟</label>
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="orderData.contractNumber"
          placeholder="أدخل رقم العقد" />
      </div>

      <div class="mobile-toggle-group">
        <p-checkbox 
          [(ngModel)]="orderData.includeVAT" 
          [binary]="true"
          (onChange)="onVATChange()">
        </p-checkbox>
        <label>يشمل الضريبة</label>
      </div>
      <div style="height: 1px; border-top: 1px solid #B8B3FD; margin: 6px 0; width: 100%;"></div>
      <!-- Product Items -->
      <div class="mobile-section-title">تفاصيل المنتجات</div>

      <div *ngFor="let row of orderItemRows; let i = index" class="mobile-item-block">
        <div class="mobile-field-group">
          <label>المنتج/كود المنتج</label>
          <p-dropdown 
            [(ngModel)]="row.productId"
            [options]="productOptions" 
            placeholder="اختر منتج"
            [showClear]="true"
            [filter]="true"
            (onChange)="onProductChange(i, $event)">
          </p-dropdown>
        </div>

        <div class="mobile-two-cols">
          <div class="mobile-field-group">
            <label>الكمية</label>
            <input 
              pInputText 
              type="number" 
              [(ngModel)]="row.quantity"
              (ngModelChange)="onQuantityChange(i)"
              placeholder="0" 
              min="0" />
          </div>

          <div class="mobile-field-group">
            <label>السعر</label>
            <input 
              pInputText 
              type="number" 
              [(ngModel)]="row.price"
              (ngModelChange)="onPriceChange(i)"
              placeholder="0.00" 
              min="0" 
              step="0.01" />
          </div>
        </div>

        <div class="mobile-three-cols">
          <div class="mobile-col-item">
            <span class="mobile-col-label">الإجمالي</span>
            <span class="mobile-col-value">{{formatCurrency(row.totalBeforeTax)}}</span>
          </div>
          <div class="mobile-col-item">
            <span class="mobile-col-label">الضريبة</span>
            <span class="mobile-col-value">{{formatCurrency(row.taxAmount)}}</span>
          </div>
          <div class="mobile-col-item">
            <span class="mobile-col-label">الإجمالي مع الضريبة</span>
            <span class="mobile-col-value">{{formatCurrency(row.totalWithTax)}}</span>
          </div>
        </div>

        <button 
          *ngIf="orderItemRows.length > 1"
          pButton 
          type="button" 
          label="حذف"
          class="mobile-delete-btn"
          (click)="removeRow(i)">
        </button>
      </div>

      <button 
        pButton 
        type="button" 
        label="+ إضافة سطر" 
        class="mobile-add-line-btn" 
        (click)="addRow()">
      </button>


<div class="mobile-grand-totals">
  <div class="mobile-grand-total-col">
    <span class="mobile-grand-label">الإجمالي</span>
    <span class="mobile-grand-value">{{formatCurrency(getTotalBeforeTax())}}</span>
  </div>
  <div class="mobile-grand-total-col">
    <span class="mobile-grand-label">الضريبة</span>
    <span class="mobile-grand-value">{{formatCurrency(getTotalTax())}}</span>
  </div>
  <div class="mobile-grand-total-col">
    <span class="mobile-grand-label">الإجمالي مع الضريبة</span>
    <span class="mobile-grand-value">{{formatCurrency(getTotalWithTax())}}</span>
  </div>
</div>

<div style="height: 1px; border-top: 1px solid #B8B3FD; margin: 6px 0; width: 100%;"></div>
      <!-- Notes -->
      <div class="mobile-section-title">ملاحظات وملخص</div>

      <div class="mobile-field-group">
        <label>ملاحظات</label>
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="orderData.notes"
          placeholder="أدخل ملاحظات" />
      </div>
    </div>

    <!-- Mobile Save Button -->
    <div class="mobile-form-actions">
      <button 
        pButton 
        label="حفظ" 
        class="mobile-save-button" 
        (click)="onSave()"
        [disabled]="loading">
      </button>
    </div>
  </div>
</p-dialog>